---
title: "Lecture 12 Notes"
author: "Alec L. Robitaille"
date: "2024-04-04"
---

```{r, include = FALSE}
source('R/packages.R')
```


# Multilevel models

Repeat observations within groups can be modeled using categorical variables eg.
a vector of alphas for each individual. Categorical variables have 
*anterograde amnesia*, when estimating eg. the beta for an individual, 
this estimate does not contribute anything to the next individual. 

Multilevel models are made up of two kinds of models

1. Model observations of groups/individuals 
1. Model populations of groups/individuals (clusters)

The population model creates a kind of memory. Advantages of multilevel model
include: 

- more efficient estimation 
- resists overfitting

The order that we estimate clusters does not matter, because we update the 
population level model with every cluster estimate and that 
population level model contributes to all clusters' estimates. The 
information gathered from each cluster is pooled. 


## Regularization

Types of pooling:

- Complete pooling where all clusters are the same. This results in underfitting 
because the model is not complex enough for the variation in the sample.
- No pooling where all clusters are unrelated. This results in overfitting because 
there may be only a small amount of data for any particular individual/group .
- Partial pooling, an adaptive compromise. There is shrinkage towards
the global mean.

Regularization with multilevel models is partial pooling, an adaptive 
compromise. 


## Example: cafes

![](../graphics/stat_rethinking_l12_slide14.png)

Top left plot is the population of cafes and the remaining plots are individual
cafes. The black line is the current observation. The grey distribution is the 
previous posterior distributions, now prior distributions. The prior of an 
unobserved cafe is similar to previously observed cafes. The posterior
distribution of all other cafes are updated when you observe a new cafe
or an old cafe again. The population model learns variation from all cafes. 

Reminder: the minimum sample size is 1

## Example: reedfrogs

- 48 tanks (T) of reedfrogs
- treatments: density (D), size (G), predation (P)
- outcome: survival (S)

```{r}
coords <- data.frame(
	name = c('D', 'G', 'P', 'T', 'S'),
	x =    c(1,    2,   3,   1,    2),
	y =    c(0,    0,   0,   1,  1)
)
```

```{r}
#| fig.height: 4
#| fig.width: 4 
dagify(
	S ~ D + G + P + T,
  coords = coords
) |> ggdag(seed = 2, layout = 'auto') + theme_dag()
```


$S_{i} \sim Binomial(D_{i}, p_{i})$

$logit(p_{i}) = \alpha_{T[i]}$

$\alpha_{j} \sim Normal(\bar{\alpha}, \sigma)$

$\bar{\alpha} \sim Normal(0, 1.5)$


<!-- ![](../graphics/stat_rethinking_l12_slide34.png) -->

