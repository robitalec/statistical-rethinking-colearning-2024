---
title: "Lecture 13 Notes"
author: "Alec L. Robitaille"
date: "2024-04-17"
---

```{r, include = FALSE}
source('R/packages.R')
```


# Clusters and features

Clusters: kinds of groups in the data

Features: aspects of the model (parameters) that vary by cluster

Examples (clusters -> features): 

- tanks -> survival
- stories -> treatment effect
- individuals -> average responses
- departments -> admission rate, bias


Adding more clusters involves adding more index variables and more population
priors.

Adding more features involves adding more parameters, increasing the dimensions
in each population prior.


Varying effects are a way to measure unmeasured confounds. Unmeasured features
of clusters leave an imprint on the data that can be estimated given
repeat observations of each cluster and partial pooling among clusters. 

This helps us, from the predictive perspective, to regularize cluster-level 
variance, and, from the causal perspective, to manage unobserved confounds
and competing causes using cluster-level causes. 

Practical difficulties of varying effects:

- How to use more than one cluster type at the same time?
- How to calculate predictions? At which level?
- How to sample chains efficiently?
- Group-level confounding


# Strategy for modeling varying effects 

1. Varying intercept on one cluster
1. Varying intercept for one cluster, slope for another cluster. This
is two 1-dimensional distributions where information is not shared across. 
1. Correlated varying effects


## Example: Bangladesh fertility survey

Outcome: contraceptive use

Variables: age, living children, urban/rural, districts

```{r}
#| fig.height: 4
#| fig.width: 4 

coords <- data.frame(
	name = c('A', 'C', 'D', 'K', 'U'),
	x =    c(1,    2,    3,   1.5, 2.5),
	y =    c(0,    0.5,    0,  -1, -1)
)
dagify(
	C ~ A + K + D + U,
	K ~ A + U,
	U ~ D,
  coords = coords
) |> ggdag(seed = 2, layout = 'auto') + theme_dag()
```



In addition,

- group level confounds: unmeasured things about districts may influence features
of individuals in those districts (eg. history of districts)

- unmeasured variables: family


## Varying intercepts on each district

$C_{i} \sim Bernoulli(D_{i}, p_{i})$

$logit(p_{i}) = \alpha_{D[i]}$

$\alpha_{j} \sim Normal(\bar{\alpha}, \sigma)$

$\bar{\alpha} \sim Normal(0, 1)$

$\sigma \sim  Exponential(1)$


(Bernoulli distribution since contraception is 0/1 outcome)


Note the uneven sampling across districts, where because of partial pooling
there is shrinkage in the clusters. More shrinkage in clusters with less
observations eg. the districts with 2 and 13 observations, and less in clusters
with more observations eg. the districts with 35 and 45 observations. 

![](../graphics/stat_rethinking_l13_slide42.png)

In addition, for one district there is no data. The minimum sample size is 0, 
because you have a prior. This is an informed prior because it is estimated
from all the other districts, including the variation across all districts. 
This is in essence a prediction. 

![](../graphics/stat_rethinking_l13_slide43.png)
